#********************************************************************
# $Author: jgoerzen $
# $Revision: 1.11 $
# $Date: 2002/03/20 20:47:29 $
# $Source: /home/jgoerzen/tmp/gopher-umn/gopher/head/gopherd/Makefile.in,v $
# $State: Exp $
#
# 
##COPYRIGHT##
# Copyright (C) 1991-2000  University of Minnesota
# Copyright (C) 2000-2002  John Goerzen and other developers
# See the file "Copyright" in the distribution for conditions of use.
##COPYRIGHT##

#********************************************************************
# MODULE: Makefile
# Makefile for gopher server
#********************************************************************

include ../Makefile.config

srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = @srcdir@

#
# Type of full-text searching to use....  WAIS
# requires that you have a built wais distribution.
#
# Next requires that you have the NeXTtext.tar.Z libraries.
#

LIBS	= $(SERVERLIBS)

#############################################################################

WAISOBJ         = ../bin/inv.a ../bin/client.a ../bin/wais.a \
                  ../ui/source.o ../bin/libftw.a
SF1WAISOBJ       = ../ir/libinv.a ../ir/libwais.a ../ir/liblocal.a\
		  ../ui/source.o ../ir/libinv.a ../regexp/libregexp.a
SFWAISOBJ      = ../ir/libwais.a ../ui/source.o ../regexp/libregexp.a 


CCFLAGS	= $(OPT) -DDATA_DIRECTORY=\"$(SERVERDATA)\" $(DEBUGGING) \
	-DGOPHER_PORT=$(SERVERPORT) \
	-DGDCDIR=\"$(SERVERDIR)\" @SEARCH@ \
	$(SEARCH) $(WAISTYPE) $(SERVEROPTS) $(INTLOPTS) -I..\
	-I@top_srcdir@ -I@top_srcdir@/object

OBJS	= error.o globals.o gopherd.o daemon.o special.o \
	dedot.o openers.o index.o Waisindex.o serverutil.o ftp.o \
	waisgopher.o ext.o site.o gopherdconf.o kernutils.o mindexd.o \
	authenticate.o command.o pid.o AUTH.o GGroup.o

TARGET	= gopherd

gopherd.conf: gopherd.conf.in
	sed 's,@sysconfdir\@,$(SYSCONFDIR),g' $< > $@

all: $(OBJS) @NEXTOBJS@ gopherd.conf
	$(CC) @LDFLAGS@ -o $(TARGET) $(OBJS) $(DLOBJS) ../object/libgopher.a  @NEXTOBJS@ @GOPHERDLIBS@ @REGEXLIBS@ @LIBS@

#
# Special rule for NeXT text indexing, can't use gcc (yet...)
#
NeXTindex.o : NeXTindex.c
	cc $(CCFLAGS) -ObjC -I. -c $(srcdir)/NeXTindex.c

#
# Special rule for wais gateway
#
waisgopher.o: waisgopher.c
	$(CC) $(CCFLAGS) -I../wais/ir -I../wais/ui -c $(srcdir)/waisgopher.c

Waisindex.o: Waisindex.c
	$(CC) $(CCFLAGS) -I../wais/ir -c $(srcdir)/Waisindex.c

gopherd.o: gopherd.c $(top_srcdir)/patchlevel.h
	$(CC) $(CCFLAGS) -DCONF_FILE=\"$(SERVERCONFDIR)/gopherd.conf\" -c \
		$(srcdir)/gopherd.c

.c.o:
	$(CC) $(CCFLAGS) -c $<

globals.o : $(srcdir)/globals.h

$(OBJS) : $(top_srcdir)/conf.h 


install : all
	-mv $(SERVERDIR)/$(TARGET) $(SERVERDIR)/$(TARGET).old
	-mv $(SERVERCONFDIR)/gopherd.conf $(SERVERCONFDIR)/gopherd.conf.old

	@if [ ! -d $(SERVERDIR) ]; then \
		echo "Creating $(SERVERDIR)" ;\
		mkdir $(SERVERDIR) ;\
	fi

	@INSTALL@  $(TARGET) $(SERVERDIR)
	@INSTALL@ -d $(SERVERCONFDIR)
	@INSTALL@  gopherd.conf $(SERVERCONFDIR)
	if [ ! -f $(SERVERCONFDIR)/gopherdlocal.conf ]; then \
		@INSTALL@ gopherdlocal.conf $(SERVERCONFDIR); \
	fi

	if [ -f gopherindex ]; then \
		@INSTALL@  gopherindex $(SERVERDIR); \
	fi
	-rm	$(SERVERDIR)/gopherls $(SERVERDIR)/gindexd
	-@LN_S@ $(TARGET) $(SERVERDIR)/gopherls
	-@LN_S@ $(TARGET) $(SERVERDIR)/gindexd
	(cd scripts; $(MAKE) $(MFLAGS) install)
	(cd icons; $(MAKE) $(MFLAGS) install)

clean:
	-rm -f $(TARGET) $(OBJS) $(NEXTOBJ) *.out *~ core gopherindex \
		gopherd.conf



